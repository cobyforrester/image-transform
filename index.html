<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <input id="inputFileToLoad" type="file" onchange="onChange();" />
    <div id="imgTest"></div>
</body>
<script>
    let srcData = null
    let newSrcData = null
    const onChange = () => {
        srcData = null
        newSrcData = null
        encodeImageFileAsURL()
        loadGQL()
        loadGQLRes()
    }
    const loadGQL = ()=> {
        let c = 0
        let interval = setInterval(() => { 
            c++
            if (srcData != null) {
                sendRequest()
                clearInterval(interval)
            } else if (c > 100) {
                alert("Invalid PNG")
                clearInterval(interval)
            }
        }, 100);
    }
    const loadGQLRes = ()=> {
        let c = 0
        let interval = setInterval(() => { 
            c++
            if (newSrcData != null) {
                setImage()
                clearInterval(interval)
            } else if (c > 100) {
                alert("Invalid PNG")
                clearInterval(interval)
            }
        }, 100);
    }
    const encodeImageFileAsURL = () => {
        const filesSelected = document.getElementById("inputFileToLoad").files;
        if (filesSelected.length > 0) { 
            const fileToLoad = filesSelected[0];
            const fileReader = new FileReader();

            fileReader.onload = function(fileLoadedEvent) {
                srcData = fileLoadedEvent.target.result // <--- data: base64
            }
            fileReader.readAsDataURL(fileToLoad)
        }
    }

    const sendRequest = async () => {
        const input = `{
            image: {
                base64: "${srcData}",
                type: "png",
                options: {
                    tint: true
                }
            }
        }`
        const body = JSON.stringify({
            query: `
            mutation transformJsonImage {
                transformJsonImage(input: ${input}) 
            }
            `,
            variables: {
            now: new Date().toISOString(),
            },
        })
        // const input = {image: srcData, tint:true}
        // const body = JSON.stringify({
        //     query: `
        //     mutation transformImage {
        //         transformImage(input:{image:"${srcData}", tint:true}) 
        //     }
        //     `,
        //     variables: {
        //     now: new Date().toISOString(),
        //     },
        // })
        const payload = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: body,
        }
        const res = await fetch('http://localhost:8081/query', payload)
        const data = await res.json()
        newSrcData = await data.data.transformJsonImage

    }

    const setImage = () => {
        const newImage = document.createElement('img')
        newImage.src = newSrcData
        document.getElementById("imgTest").innerHTML = newImage.outerHTML
    }
</script>
</html>