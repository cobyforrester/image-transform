<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        div input {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div>
        <input id="inputFileToLoad" type="file" /><br>
        <label for="rotate">Rotate: </label>
        <input type="number" id="rotate" name="rotate" placeholder="90(in degrees)"><br>

        <label for="scale">Scale </label>
        <input type="number" id="scale" name="scale" placeholder="4"><br>
        
        <label for="blur">Blur: </label>
        <input type="number" id="blur" name="blur" placeholder="1.5"><br>

        <label for="invert"> Invert Colors</label>
        <input type="checkbox" id="invert" name="invert"><br>
        <label for="grayscale"> GrayScale</label>

        <input type="checkbox" id="grayscale" name="grayscale"><br><br>
        <input type="submit" value="Submit" onclick="onSubmit();">
    </div> 
    <div id="imgTest"></div>
</body>
<script>
    let srcData = null
    let newSrcData = null
    const onSubmit = () => {
        srcData = null
        newSrcData = null
        if (encodeImageFileAsURL()) return
        loadGQL()
        loadGQLRes()
    }
    const loadGQL = ()=> {
        let c = 0
        let interval = setInterval(() => { 
            c++
            if (srcData != null) {
                sendRequest()
                clearInterval(interval)
            } else if (c > 50) {
                alert("Invalid PNG")
                clearInterval(interval)
            }
        }, 100);
    }
    const loadGQLRes = ()=> {
        let c = 0
        let interval = setInterval(() => { 
            c++
            if (newSrcData != null) {
                setImage()
                clearInterval(interval)
            } else if (c > 50) {
                alert("Invalid PNG")
                clearInterval(interval)
            }
        }, 100);
    }
    const encodeImageFileAsURL = () => {
        const filesSelected = document.getElementById("inputFileToLoad").files;
        if (filesSelected.length > 0) { 
            const fileToLoad = filesSelected[0];
            const fileReader = new FileReader();

            fileReader.onload = function(fileLoadedEvent) {
                srcData = fileLoadedEvent.target.result // <--- data: base64
            }
            fileReader.readAsDataURL(fileToLoad)
        } else {
            alert('No Image')
            return true
        }
    }

    const sendRequest = async () => {
        const input = `{
            image: {
                base64: "${srcData}",
                options: {
                   ${buildInput()} 
                }
            }
        }`
        const body = JSON.stringify({
            query: `
            mutation transformJSONImage {
                transformJSONImage(input: ${input}) 
            }
            `,
            variables: {
            now: new Date().toISOString(),
            },
        })
        // const input = {image: srcData, tint:true}
        // const body = JSON.stringify({
        //     query: `
        //     mutation transformImage {
        //         transformImage(input:{image:"${srcData}", tint:true}) 
        //     }
        //     `,
        //     variables: {
        //     now: new Date().toISOString(),
        //     },
        // })
        const payload = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: body,
        }
        const res = await fetch('http://localhost:8081/query', payload)
        const data = await res.json()
        newSrcData = await data.data.transformJSONImage

    }

    const setImage = () => {
        const newImage = document.createElement('img')
        newImage.src = newSrcData
        document.getElementById("imgTest").innerHTML = newImage.outerHTML
    }

    const buildInput = () => {
        let str = ""
        if (document.getElementById("grayscale").checked) {
            str += `grayscale: true,\n`
        }
        if (document.getElementById("invert").checked) {
            str += `invert: true,\n`
        }

        const scale = document.getElementById("scale").value
        const rotate = document.getElementById("rotate").value
        const blur = document.getElementById("blur").value
        if (scale) {
            str += `scale: ${scale},\n`
        }
        if (rotate) {
            str += `rotate: ${rotate},\n`
        }
        if (blur) {
            str += `blur: ${blur},\n`
        }
        return str
    }
</script>
</html>